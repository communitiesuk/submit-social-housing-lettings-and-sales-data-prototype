{% extends "layouts/form.njk" %}

{% import "macros.njk" as macro %}
{% from "macros.njk" import organisationNavigation with context %}

{% set title = "Logs" %}
{% set typeName = type | capitalize %}

{% block pageNavigation %}
  {{ govukBreadcrumbs({
    items: [{
      href: "/organisations",
      text: "Organisations"
    }, {
      href: organisationPath,
      text: organisation.name
    }, {
      text: title
    }]
  }) if isAdmin and activeSection != "users" }}
{% endblock %}

{% block form %}
  {{ govukNotificationBanner({
    text: macro.notificationBannerText(query.success, query.logId),
    type: "success"
  }) if query.success }}

  {{ macro.heading(organisation.name) }}

  {{ organisationNavigation(organisationPath, title, isOwningOrg) }}

  {# appSubNavigation({
      items: [{
      href: "/logs?type=lettings",
      text: "Lettings",
      active: type == "lettings"
    }, {
      href: "/logs?type=sales",
      text: "Sales",
      active: type == "sales"
    }]
  }) #}
  <h2 class="govuk-visually-hidden">{{ typeName }}</h2>

  <div class="app-filter-layout" data-module="filter-layout">
    <div class="app-filter-layout__filter">
      {{ appFilter({
        title: "Filters"
      }) }}
    </div>

    <div class="app-filter-layout__content">
      <div class="govuk-button-group app-filter-toggle">
        {{ govukButton({
          text: "Create a new " + type + " log",
          name: "type",
          value: type,
          attributes: {
            formaction: "/logs/create"
          }
        }) }}
        <a class="govuk-link govuk-link--no-visited-state" href="#">
          Upload logs
        </a>
      </div>

      {%- set logRows = [] -%}
      {% set logs = logs | where("type", type) %}
      {% for log in logs | reverse %}
        {% set row = logRows.push([{
            html: "<a href=\"/logs/" + log.id + "\">" + log.id + "</a>"
          }, {
            classes: "app-!-font-tabular",
            text: log.setup["tenant-code"] or "—"
          }, {
            classes: "app-!-font-tabular",
            text: log.setup["property-reference"] or "—"
          }, {
            text: log.setup["letting-start-date"] | textFromInputValue
          }, {
            html: log.created | govukDate
          }, {
            html: govukTag({
              classes: "govuk-tag--" + data.statuses[log.status].colour,
              text: data.statuses[log.status].text
            }) if log.status else log.progress
          }])
        %}
      {% endfor %}

      {% if logs | length > 0 %}
        <figure class="app-figure">
          <figcaption id="logs" class="app-figure__caption">
            <span class="govuk-!-margin-right-4">
              <b>56</b> logs found of <b>217</b> total logs
            </span>
            <a class="govuk-link govuk-link--no-visited-state" href="#" download>Download (CSV)</a>
          </figcaption>
          {% call appTableGroup({
            labelledby: "logs"
          }) %}
            {{ govukTable({
              firstCellIsHeader: true,
              head: [{
                text: "Log"
              }, {
                text: "Tenant"
              }, {
                text: "Property"
              }, {
                text: "Tenancy starts"
              }, {
                text: "Log created"
              }, {
                text: "Completed"
              }],
              rows: logRows
            }) }}
          {% endcall %}
        </figure>

        {{ appPagination({
          items: [{
            href: "/?type=" + type + "page=1",
            text: "1"
          }, {
            href: "/?type=" + type + "page=2",
            text: "2",
            current: "true"
          }, {
            href: "/?type=" + type + "page=3",
            text: "3"
          }, {
            href: "/?type=" + type + "page=4",
            text: "4"
          }, {
            href: "/?type=" + type + "page=5",
            text: "5"
          }],
          next: {
            href: "/?type=" + type + "page=3"
          },
          previous: {
            href: "/?type=" + type + "page=1"
          },
          results: {
            to: logs | length,
            from: 1,
            count: 56,
            type: "logs"
          }
        }) }}
      {% else %}
        <p class="govuk-body">No {{ type }} logs found.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
