{% extends "layouts/base.njk" %}

{% import "macros.njk" as macro %}
{% from "macros.njk" import adminNavigation with context %}

{% set title = "Supported services" %}
{% set caption = thisOrganisation.name %}
{% set isGlobalView = isAdmin and path.startsWith("/schemes") %}

{% block content %}
  {{ govukNotificationBanner({
    text: macro.notificationBannerText(query.success, query.logId),
    type: "success"
  }) if query.success }}

  {% if isGlobalView %}
    {{ macro.heading(title) }}
  {% else %}
    {{ adminNavigation(title) if isAdmin else macro.heading(title, caption) }}
  {% endif %}

  {{ govukButton({
    href: "/schemes/new",
    text: "Create a new supported service"
  }) }}

  {{ appSearch({
    decorate: "q",
    classes: "govuk-!-margin-bottom-4",
    label: {
      classes: "govuk-!-margin-bottom-2",
      text: "Search by service name or postcode"
    }
  }) }}

  <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--m">

  {% set schemeRows = [] %}
  {% for scheme in results %}
    {% set schemePath = "/schemes/" + scheme.id %}
    {% set schemePropertyCount = scheme.properties | length %}
    {% set schemeDescription %}
      {% if schemePropertyCount > 1 %}
        {{ schemePropertyCount }} properties
      {% else %}
        {{ scheme.properties.p1.address }}, {{ scheme.properties.p1.postcode }}
      {% endif %}
    {% endset %}
    {% set addPropertyHtml %}
      <a class="govuk-link govuk-link--no-visited-state" href="{{ schemePath }}/property/new">
        Add a property
        <span class="govuk-visually-hidden">to {{ scheme.name }}</span>
      </a>
    {% endset %}
    {% set row = schemeRows.push([{
        classes: "govuk-!-text-align-left",
        text: scheme.id,
        format: "numeric"
      }, {
        html: macro.entityHtml(scheme.name, schemePath, schemeDescription)
      }, {
        html: organisations[scheme.agentId].name
      }, {
        html: (scheme["start-date"] | textFromInputValue | govukDate) + (" to <br>" + (scheme["end-date"] | textFromInputValue | govukDate) if scheme["end-date"])
      }, {
        html: addPropertyHtml
      }])
    %}
  {% endfor %}

  {% set captionHtml %}
    <span class="govuk-!-margin-right-4">
      {% if q %}<b>56</b> services found of{% endif %}
      <b>{{ pagination.results.count }}</b> total services
    </span>
  {% endset %}

  {% if results.length %}
    {% call appFigure ({
      id: "services",
      caption: {
        html: captionHtml
      }
    }) %}
      {% call appTableGroup({
        labelledby: "services"
      }) %}
        {{ govukTable({
          head: [{
            text: "Code"
          }, {
            text: "Name"
          }, {
            text: "Managing agent"
          }, {
            text: "Operating dates"
          }, {
            text: "Actions"
          }],
          rows: schemeRows
        }) }}
      {% endcall %}
      {{ appPagination(pagination) }}
    {% endcall %}
  {% else %}
    <p class="govuk-body">
      <strong>No supported housing services found</strong>
    </p>
  {% endif %}
{% endblock %}
